{% extends "base.html" %} {% block title %}Dictionary Mapping{% endblock %} {% block content%}
    <div class="page-container">
        <h3>Dictionary Mapping</h3>
        <br />
        <div id="handsontable-container"></div>
        <br />
        <button id="save-button" class="btn btn-primary" disabled>Save changes</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/handsontable/dist/handsontable.full.min.css">

    <script>
        let projectDropDown = [];
        const saveButton = document.getElementById('save-button');
        let handsOnTable;

        const colHeaders = ["Column", "Attribute", "Attribute Of", "Entity", "Unit", "Format",
                             "Property", "Time", "Relation", "In Relation To", "Label", "Role",
                             "Definition", "Comment", "Was Derived From", "Was Generated By"];

        fetch('/projects').then(resp => resp.json())
        .then(data => {
            console.log("Lista de proj:", data)
            projectDropDown = data.map(it => it.project_name);
            initializeTable(getEmptyData());
        }).catch(e => console.log("erro:", e));

        function getEmptyData(projectName = "") {
          let firstRow = Array(colHeaders.length).fill("");
          firstRow[0] = "Project";
          firstRow[3] = projectName;

          return [firstRow];
        }

        async function initializeTable(data) {
            const container = document.getElementById('handsontable-container');
            console.log("HOT com dados:", data)
            if (handsOnTable) handsOnTable.destroy();

            handsOnTable = new Handsontable(container, {
                data: data,
                colHeaders: colHeaders,
                rowHeaders: true,
                columns: colHeaders.map(() => ({ type: 'text' })),
                cells: function(row, col){
                  const cellsProperties = {};

                  if (row === 0 && col === 0){
                    cellsProperties.readOnly = true;
                  }

                  if (row === 0 && col === 3){
                    cellsProperties.type = 'dropdown';
                    cellsProperties.source = projectDropDown;
                  }

                  return cellsProperties;
                },
                afterChange: function(changes, source) {
                    if (source === 'edit' || source === 'Autofill.fill') {
                        changes.forEach(([row, prop, oldVal, newProjectSelected]) => {
                            if (row === 0 && prop === 3 && newProjectSelected) {
                                loadProject(newProjectSelected);
                            }
                        });
                    }
                },
                minSpareRows: 1,
                licenseKey: 'non-commercial-and-evaluation'
            });
            saveButton.disabled = false;
        }

        function loadProject(project) {
            fetch(`/loadDictionaryMapping/${encodeURIComponent(project)}`)
            .then(resp => resp.json())
            .then(data => {
                if (data.length > 0){
                    initializeTable(data);
                    console.log("Load DM:", data);
                } else {
                    initializeTable(getEmptyData(project));
                }
            }).catch(e => console.error('Error loading Dictionary Mapping:', e))
        }

        saveButton.addEventListener('click', () => {            
            const dataInserted = handsOnTable.getData();
            const projectChosen = dataInserted[0][3]; 

            if (!projectChosen) {
                alert("Choose a project in the 'Project' row before saving!");
                return;
            }

            fetch(`/saveDictionaryMapping/${encodeURIComponent(projectChosen)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data:dataInserted })
            }).then(resp => resp.json())
            .then(result => {
                if (result.status === 'ok'){
                    alert("Changes saved successfully!");
                }
            }).catch(e => console.error('Error saving Dictionary Mapping:', e));
        });
        console.log(csvData);
    </script>

    <style>
        .page-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #handsontable-container {
            margin: 0 auto;
            width: 85%;
        }
    </style>
{% endblock %}